<!DOCTYPE html>

<html>
    <head>

        <title>Data Processing - 2</title>

    </head>
    <body>
		<h1>Data Processing | Week 2</h1>
		
		<p> Name: Puja Chandrikasingh </br>
		Student number: 11059842
		</p>
        
        <textarea id="rawdata"></textarea>
		
		<p>Take a look at <a href="data1.csv." target="_blank">the data</a>. It's also shown in the text area above.</p>
        

        <canvas id="canvas" width="750" height="100"
			style="position: absolute; z-index: 0;"></canvas>
			
		<canvas id="canvas_cross" width="750" height="100"
			style="position: absolute; z-index: 1;"></canvas>

        <script>	
			// constants
			var BORDER = 50;
			var DELTA = 50;
			var LINE_SIZE = 5;
			var maxTemp;
		
			function drawCross(canvas, x, y) {
				var cross = canvas.getContext('2d');
				var y_really = -maxTemp + y;
				
				if(y_really < -maxTemp){
					y_really = -maxTemp;
				}
					
				if(x >= 0){
					cross.beginPath();
					
					cross.setTransform(1, 0, 0, 1, 0, 0);
					cross.clearRect(0, 0, canvas.width, canvas.height);
					
					// Move origin of the canvas to the origin of the dates and temperature 0
					cross.translate(BORDER, maxTemp + BORDER);
					
					cross.moveTo(x, y_really);
					cross.lineTo(x,0);
					cross.moveTo(x, y_really);
					cross.lineTo(0, y_really);
					cross.stroke();
				}
			  }
			  
			  function getMousePosistion(canvas, evt) {
				var rect = canvas.getBoundingClientRect();
				return {
				  x: evt.clientX - rect.left - BORDER,
				  y: evt.clientY - rect.top - BORDER
				};
			  }
					
            function myfunction(){
				var dates = [];
				var temps = [];
				var startline = 0;
	
                var lines = document.getElementById("rawdata").innerHTML.split("\n");
				
                // splits de data in twee array's: 1 voor de datum en 1 voor de temperatuur
				// length - 1 want extra plek in lines...
				for(var line = 0; line < lines.length; line++){
					if(lines[line][0] == "#" || lines[line][1] == "#"){
						startline++;
					}
					else {
						break;
					}
				}
				
				for(var line = startline; line < lines.length - 1; line++){					
                    temps.push(lines[line].split(",")[2]);
					
					dateText = lines[line].split(",")[1].trim();										
					// pak eerst jaar, dan maand (-1 want v 0-11), dan dag
					date = new Date(dateText.substring(0, 4), dateText.substring(4,6) - 1, dateText.substring(6,8));					
					dates.push(date);                
                }
				
				// Controle kan er UIT
				console.log("Dates" + dates);
				console.log("temps" + temps);
				console.log("min :" + Math.min(...temps));
				console.log("max :" + Math.max(...temps));
				 
				
				
				// get canvas ready to draw on
				var canvas = document.getElementById('canvas');
				var ctx = canvas.getContext('2d');	
				ctx.lineWidth = 2;
				ctx.lineJoin = 'round';
				
				// resize height
				maxTemp = Math.ceil(Math.max(...temps)/DELTA)*DELTA;
				var minTemp = Math.round(Math.min(...temps)/DELTA)*DELTA;
				canvas.height = Math.abs(maxTemp) + Math.abs(minTemp) + BORDER;
				
				// make transformation function for the dates									
				var transformation = createTransform([dates[0], dates[dates.length -1 ]], [0, canvas.width-BORDER]);
				
				// Move origin of the canvas to the origin of the dates and temperature 0
				ctx.translate(BORDER, maxTemp + BORDER);
					
				// draw x axis
				ctx.beginPath();
				var firstDate = transformation(dates[0]);
				ctx.strokeStyle = "black";
				ctx.moveTo(firstDate, 0);
				ctx.lineTo(transformation(dates[dates.length -1]), 0);
				ctx.fillStyle = "#7E57C2";
				ctx.font = '15px arial';
				ctx.fillText("Time", transformation(dates[dates.length - 50]), LINE_SIZE * 6);
				
				// draw y axis
				ctx.moveTo(firstDate, -maxTemp);
				ctx.lineTo(firstDate, -minTemp);
				ctx.rotate(-Math.PI / 2);
				ctx.fillText("Temperature (degrees Celsius)", 0, -BORDER / 2 - LINE_SIZE * 2);
				ctx.rotate(Math.PI / 2);
				
				// draw title
				ctx.font = '20px arial';
				ctx.fillStyle = "#673AB7";
				ctx.fillText("Average temperature 1997, De Bilt (NL)", canvas.width / 4, -maxTemp-BORDER / 2);
				ctx.font = '10px arial';
				ctx.fillText("Source: KNMI", canvas.width / 4, -maxTemp-BORDER / 4);
				ctx.fillStyle = "black";
				ctx.font = '12px arial';
				
				// draw lines and text in y axis
				for (var i = -1 * maxTemp + DELTA; i < -1 * minTemp; i = i + DELTA) {
					ctx.moveTo(firstDate - LINE_SIZE, i);
					ctx.lineTo(firstDate + LINE_SIZE,i);
					ctx.fillText(-1 * i / 10, firstDate - BORDER / 2, i + LINE_SIZE);
				}
				
				// change path for color change
				ctx.stroke();
				ctx.beginPath();
				ctx.strokeStyle = "#E91E63"
				
				// draw first point
				ctx.moveTo(firstDate, -temps[0]);
				ctx.fillText(dates[0].toDateString().split(" ")[1], firstDate , LINE_SIZE * 3);
				
				// draw the other points
				for(var date = 1; date < dates.length; date++){
					ctx.lineTo(transformation(dates[date]), -temps[date]);
					
					// draw lines and text in x axis
					if ( dates[date].getDate() == 1){
						var x = transformation(dates[date]);
						
						// change path for color change
						ctx.stroke();
						ctx.beginPath();
						ctx.strokeStyle = "black";
						
						ctx.moveTo(x,-LINE_SIZE);
						ctx.lineTo(x,LINE_SIZE);
						ctx.fillText(dates[date].toDateString().split(" ")[1], x, LINE_SIZE * 3);
						
						// change path for color change
						ctx.stroke();
						ctx.beginPath();
						ctx.strokeStyle = "#E91E63"
						ctx.moveTo(x, -temps[date]);
					}		
					
				}
				
				// end draw graph part
				ctx.stroke();
				
				//////
				// new canvas element for cross-hair
				// get canvas ready to draw on
				var canvas_cross = document.getElementById('canvas_cross');
				canvas_cross.width = canvas.width;
				canvas_cross.height = canvas.height;
				var cross = canvas_cross.getContext('2d');
				cross.lineWidth = 3;
				cross.setLineDash([20, 5]);
				cross.lineJoin = 'round';		
				
				// mouse listener
				canvas_cross.addEventListener('mousemove', function(evt) {
					var mouse = getMousePosistion(canvas_cross, evt);
					drawCross(canvas_cross, mouse.x, mouse.y);
				}, false);				
            }  
			
			// functie gekregen
			function createTransform(domain, range){
				// domain is a two-element array of the data bounds [domain_min, domain_max]
				// range is a two-element array of the screen bounds [range_min, range_max]
				// this gives you two equations to solve:
				// range_min = alpha * domain_min + beta
				// range_max = alpha * domain_max + beta
					// a solution would be:

				var domain_min = domain[0]
				var domain_max = domain[1]
				var range_min = range[0]
				var range_max = range[1]

				// formulas to calculate the alpha and the beta
				var alpha = (range_max - range_min) / (domain_max - domain_min)
				var beta = range_max - alpha * domain_max

				// returns the function for the linear transformation (y= a * x + b)
				return function(x){
				  return alpha * x + beta;
				}				
			}
			
			
			function csv(callback) {
				// first load data, then call callback to draw graph
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						document.getElementById("rawdata").innerHTML = xhttp.responseText;
					}
				} 
				xhttp.open("GET", "data1.csv", true);
				xhttp.send();
				
				// Use timeout because otherwise data is not loaded yet
				setTimeout(function(){ callback(); }, 300);
			}
			
			// roep functie aan die called tekenfucntie zodra klaar
			csv(myfunction);
			
        </script>

    </body>
</html>
